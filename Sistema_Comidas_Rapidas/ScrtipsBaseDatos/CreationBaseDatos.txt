CREATE DATABASE ComidasRapidasDB;
GO

USE ComidasRapidasDB;
GO

/* =========================================================
   TABLA: Empleados
   Basada en tu clase Empleado
   ========================================================= */
CREATE TABLE Empleados (
    IDEmpleado      INT IDENTITY(1,1) PRIMARY KEY,      -- PK
    Nombre          VARCHAR(100) NOT NULL,
    Apellido        VARCHAR(100) NOT NULL,
    DNI             VARCHAR(20)  NOT NULL,
    FechaNacimiento DATE         NOT NULL,
    Telefono        VARCHAR(30)  NULL,
    Email           VARCHAR(100) NULL,
    Direccion       VARCHAR(200) NULL,

    FechaIngreso    DATE NOT NULL 
        CONSTRAINT DF_Empleados_FechaIngreso DEFAULT (GETDATE()),
    Puesto          VARCHAR(50) NOT NULL,
    Sueldo          DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_Empleados_Sueldo_Positive CHECK (Sueldo > 0),
    Activo          BIT NOT NULL 
        CONSTRAINT DF_Empleados_Activo DEFAULT (1),

    CONSTRAINT UQ_Empleados_DNI UNIQUE (DNI)
);
GO

/* =========================================================
   TABLA: Producto
   Basada en tu clase Producto
   (sin la lista de Proveedores ni string proveedores)
   ========================================================= */
CREATE TABLE Producto (
    IdProducto      INT IDENTITY(1,1) PRIMARY KEY,
    CodigoProducto  VARCHAR(20)  NOT NULL,
    NombreProducto  VARCHAR(100) NOT NULL,
    UnidadPaquete   INT NOT NULL
        CONSTRAINT CK_Producto_UnidadPaquete_Positive CHECK (UnidadPaquete > 0),
    CantidadUnidad  INT NOT NULL
        CONSTRAINT CK_Producto_CantidadUnidad_NoNegativa CHECK (CantidadUnidad >= 0),
    PrecioUnidad    DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_Producto_PrecioUnidad_Positive CHECK (PrecioUnidad > 0),
    FechaIngreso    DATETIME NOT NULL 
        CONSTRAINT DF_Producto_FechaIngreso DEFAULT (GETDATE()),
    Categoria       VARCHAR(50) NULL,
    Stock           INT NOT NULL 
        CONSTRAINT CK_Producto_Stock_NoNegativo CHECK (Stock >= 0),
    PrecioFinal     DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_Producto_PrecioFinal_NoNegativo CHECK (PrecioFinal >= 0),
    Activo          BIT NOT NULL 
        CONSTRAINT DF_Producto_Activo DEFAULT (1),

    CONSTRAINT UQ_Producto_Codigo UNIQUE (CodigoProducto),
    CONSTRAINT UQ_Producto_Nombre UNIQUE (NombreProducto)
);
GO
ALTER TABLE Producto
ADD IDProveedor INT NOT NULL DEFAULT 1;  -- O algún proveedor que ya exista

ALTER TABLE Producto
ADD CONSTRAINT FK_Producto_Proveedor
FOREIGN KEY (IDProveedor) REFERENCES Proveedores(IDProveedor);


INSERT INTO Producto 
(CodigoProducto, NombreProducto, UnidadPaquete, CantidadUnidad, PrecioUnidad, FechaIngreso, Categoria, Stock, PrecioFinal, Activo)
VALUES 
('P001', 'Pancho Simple', 1, 1, 100.00, GETDATE(), 'Panchos', 50, 100.00, 1);

INSERT INTO Producto 
(CodigoProducto, NombreProducto, UnidadPaquete, CantidadUnidad, PrecioUnidad, FechaIngreso, Categoria, Stock, PrecioFinal, Activo)
VALUES 
('P002', 'Pancho Completo', 1, 1, 150.00, GETDATE(), 'Panchos', 40, 150.00, 1);

INSERT INTO Producto 
(CodigoProducto, NombreProducto, UnidadPaquete, CantidadUnidad, PrecioUnidad, FechaIngreso, Categoria, Stock, PrecioFinal, Activo)
VALUES 
('B001', 'Gaseosa 500ml', 1, 1, 300.00, GETDATE(), 'Bebidas', 30, 300.00, 1);


/* =========================================================
   TABLA: Combo
   Basada en tu clase Combo
   (Ingredientes se manejan en la tabla puente ComboProducto)
   ========================================================= */
CREATE TABLE Combo (
    IdCombo         INT IDENTITY(1,1) PRIMARY KEY,
    CodigoCombo     VARCHAR(20)  NOT NULL,
    Nombre          VARCHAR(100) NOT NULL,
    Precio          DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_Combo_Precio_Positive CHECK (Precio > 0),
    Activo          BIT NOT NULL
        CONSTRAINT DF_Combo_Activo DEFAULT (1),
    FechaAlta       DATETIME NOT NULL
        CONSTRAINT DF_Combo_FechaAlta DEFAULT (GETDATE()),

    CONSTRAINT UQ_Combo_Codigo UNIQUE (CodigoCombo),
    CONSTRAINT UQ_Combo_Nombre UNIQUE (Nombre)
);
GO
INSERT INTO Combo (CodigoCombo, Nombre, Precio, Activo)
VALUES ('C001', 'Pancho Simple', 2000, 1);

CREATE TABLE ComboIngrediente (
    IdComboIngrediente INT IDENTITY(1,1) PRIMARY KEY,
    IdCombo            INT NOT NULL,
    Descripcion        VARCHAR(200) NOT NULL,
    Orden              INT NULL,

    CONSTRAINT FK_ComboIngrediente_Combo
        FOREIGN KEY (IdCombo) REFERENCES Combo(IdCombo)
);
GO
INSERT INTO ComboIngrediente (IdCombo, Descripcion, Orden)
VALUES
(1, 'Pan', 1),
(1, 'Salchicha', 2),
(1, 'Mayonesa', 3);

/* =========================================================
   TABLA: Ventas
   Basada en tu clase de Venta (IDVenta, FechaVenta, TotalPrecio,
   FormaPago, NumeroVenta, Empleado)
   ========================================================= */
CREATE TABLE Ventas (
    IDVenta         INT IDENTITY(1,1) PRIMARY KEY,
    NumeroVenta     INT NOT NULL,
    FechaVenta      DATETIME NOT NULL 
        CONSTRAINT DF_Ventas_FechaVenta DEFAULT (GETDATE()),
    TotalPrecio     DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_Ventas_TotalPrecio_NoNegativo CHECK (TotalPrecio >= 0),
    FormaPago       VARCHAR(30) NOT NULL,
    IDEmpleado      INT NULL,

    CONSTRAINT UQ_Ventas_NumeroVenta UNIQUE (NumeroVenta),

    CONSTRAINT FK_Ventas_Empleados
        FOREIGN KEY (IDEmpleado) REFERENCES Empleados(IDEmpleado)
);
GO

/* =========================================================
   TABLA PUENTE: ComboProducto
   Relación N a N entre Combo y Producto
   (qué productos y cuántas unidades lleva cada combo)
   ========================================================= */
CREATE TABLE ComboProducto (
    IdComboProducto     INT IDENTITY(1,1) PRIMARY KEY,
    IdCombo             INT NOT NULL,
    IdProducto          INT NOT NULL,
    CantidadProducto    DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_ComboProducto_Cantidad_Positive CHECK (CantidadProducto > 0),

    CONSTRAINT FK_ComboProducto_Combo
        FOREIGN KEY (IdCombo) REFERENCES Combo(IdCombo),

    CONSTRAINT FK_ComboProducto_Producto
        FOREIGN KEY (IdProducto) REFERENCES Producto(IdProducto),

    -- El mismo producto no puede repetirse dos veces dentro del mismo combo
    CONSTRAINT UQ_ComboProducto UNIQUE (IdCombo, IdProducto)
);
GO

/* =========================================================
   TABLA PUENTE: VentaCombo
   Relación N a N entre Ventas y Combo
   (qué combos y cuántos se vendieron en cada venta)
   ========================================================= */
CREATE TABLE VentaCombo (
    IdVentaCombo    INT IDENTITY(1,1) PRIMARY KEY,
    IDVenta         INT NOT NULL,
    IdCombo         INT NOT NULL,
    Cantidad        INT NOT NULL
        CONSTRAINT CK_VentaCombo_Cantidad_Positive CHECK (Cantidad > 0),
    PrecioUnitario  DECIMAL(18,2) NOT NULL
        CONSTRAINT CK_VentaCombo_Precio_Positive CHECK (PrecioUnitario > 0),

    -- Subtotal calculado automáticamente
    Subtotal        AS (Cantidad * PrecioUnitario) PERSISTED,

    CONSTRAINT FK_VentaCombo_Ventas
        FOREIGN KEY (IDVenta) REFERENCES Ventas(IDVenta),

    CONSTRAINT FK_VentaCombo_Combo
        FOREIGN KEY (IdCombo) REFERENCES Combo(IdCombo)
);
GO
CREATE TABLE Proveedores (
    IDProveedor INT IDENTITY(1,1) PRIMARY KEY,
    Nombre VARCHAR(100),
    Telefono VARCHAR(50),
    Direccion VARCHAR(150),
    Email VARCHAR(100),
    Descripcion VARCHAR(200),
    Activo BIT
);
 INSERT INTO Proveedores (Nombre, Telefono, Direccion, Email, Descripcion, Activo)
VALUES
('Coca-Cola Andina', '0800-888-8888', 'Av. Libertador 1068, Buenos Aires', 'contacto@cocacola.com', 'Proveedor de bebidas gaseosas', 1);

INSERT INTO Proveedores (Nombre, Telefono, Direccion, Email, Descripcion, Activo)
VALUES
('PepsiCo Argentina', '0800-222-7377', 'Av. del Libertador 7208, CABA', 'info@pepsico.com', 'Proveedor de bebidas y snacks', 1);

INSERT INTO Proveedores (Nombre, Telefono, Direccion, Email, Descripcion, Activo)
VALUES
('Molinos Río de la Plata', '0800-555-4321', 'Av. Eduardo Madero 1020, CABA', 'contacto@molinos.com.ar', 'Proveedor de alimentos y harinas', 1);

INSERT INTO Proveedores (Nombre, Telefono, Direccion, Email, Descripcion, Activo)
VALUES
('La Serenísima (Mastellone)', '0800-666-6005', 'Ruta 205 Km 52.5, Cañuelas', 'atencionalcliente@laserenisima.com', 'Proveedor de lácteos', 1)

select  c.CodigoCombo,c.Nombre,co.Descripcion,c.Precio,c.FechaAlta   from Combo c 

join ComboIngrediente co on co.IdCombo = c.IdCombo

where c.Activo=1


CREATE PROCEDURE dbo.SP_GuardarVentaCompleta
(
    @NumeroVenta INT,
    @TotalPrecio DECIMAL(18,2),
    @FormaPago   VARCHAR(50),
    @Detalles    dbo.DetalleVentaTVP READONLY
)
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        -- 1) INICIO TRANSACCIÓN
        BEGIN TRAN;

        --------------------------------------------------------
        -- 2) CALCULAR CUÁNTO STOCK NECESITO POR CADA PRODUCTO
        --------------------------------------------------------
        DECLARE @Necesidades TABLE
        (
            IdProducto        INT,
            CantidadNecesaria INT
        );

        INSERT INTO @Necesidades (IdProducto, CantidadNecesaria)
        SELECT 
            cp.IdProducto,
            SUM(cp.CantidadProducto * d.Cantidad) AS CantidadNecesaria
        FROM @Detalles d
        INNER JOIN ComboProducto cp ON cp.IdCombo = d.IdCombo
        GROUP BY cp.IdProducto;

        --------------------------------------------------------
        -- 3) VERIFICAR SI FALTA STOCK EN ALGÚN PRODUCTO
        --------------------------------------------------------
        IF EXISTS
        (
            SELECT 1
            FROM @Necesidades n
            INNER JOIN Producto p ON p.IdProducto = n.IdProducto
            WHERE p.Stock < n.CantidadNecesaria
        )
        BEGIN
            DECLARE 
                @NombreProd VARCHAR(200),
                @StockActual INT,
                @Necesita INT;

            SELECT TOP 1
                @NombreProd  = p.NombreProducto,
                @StockActual = p.Stock,
                @Necesita    = n.CantidadNecesaria
            FROM @Necesidades n
            INNER JOIN Producto p ON p.IdProducto = n.IdProducto
            WHERE p.Stock < n.CantidadNecesaria;

            -- Tiro error CLARO y corto la venta
            RAISERROR(
                'No hay stock suficiente del producto %s. Stock: %d, Necesita: %d',
                16, 1,
                @NombreProd, @StockActual, @Necesita
            );
        END

        --------------------------------------------------------
        -- 4) INSERTAR CABECERA DE LA VENTA
        --------------------------------------------------------
        DECLARE @IDVenta INT;

        INSERT INTO Ventas (NumeroVenta, FechaVenta, TotalPrecio, FormaPago)
        VALUES (@NumeroVenta, GETDATE(), @TotalPrecio, @FormaPago);

        SET @IDVenta = SCOPE_IDENTITY();

        --------------------------------------------------------
        -- 5) INSERTAR DETALLES EN VentaCombo DESDE EL TVP
        --------------------------------------------------------
        INSERT INTO VentaCombo (IDVenta, IdCombo, Cantidad, PrecioUnitario)
        SELECT 
            @IDVenta,
            d.IdCombo,
            d.Cantidad,
            d.PrecioUnitario
        FROM @Detalles d;

        --------------------------------------------------------
        -- 6) DESCONTAR STOCK SEGÚN LAS NECESIDADES TOTALES
        --------------------------------------------------------
        UPDATE p
            SET p.Stock = p.Stock - n.CantidadNecesaria
        FROM Producto p
        INNER JOIN @Necesidades n ON p.IdProducto = n.IdProducto;

        --------------------------------------------------------
        -- 7) TODO OK → CONFIRMO TRANSACCIÓN
        --------------------------------------------------------
        COMMIT TRAN;
    END TRY
    BEGIN CATCH
        -- SI PASA ALGO MAL → VUELVO TODO PARA ATRÁS
        IF @@TRANCOUNT > 0
            ROLLBACK TRAN;

        -- Reenvío el mensaje de error para que lo veas en C#
        DECLARE @Msg NVARCHAR(4000);
        SELECT @Msg = ERROR_MESSAGE();

        RAISERROR(@Msg, 16, 1);
        RETURN;
    END CATCH
END
GO

CREATE TYPE dbo.DetalleVentaTVP AS TABLE
(
    IdCombo        INT NOT NULL,
    Cantidad       INT NOT NULL,
    PrecioUnitario DECIMAL(18,2) NOT NULL
);
GO